
<!--<meta http-equiv="refresh" content="1" />-->
<head>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        var app = {
            "name": "TCP Graphs",
            "progress": 80
        };
    </script>
</head>

<body>
    <h1>input</h1>
    <div>
        <textarea type="text" id="input" style="font-family: monospace; width:500px; height:200px;" onkeyup="refresh();">
        </textarea>
    </div>

    <h1>graph</h1>

    <div id="tcp_graph" style="width: 800; height: 400px;"></div>

    <h1>Settings</h1>

        <ul id="fields" style="width: 400px; heaght: 100px; list-style: outside none;">
            <li>TEST</li>
        </ul>
    <!--<div id="summary" style="width: 400; height: 100px;"></div>-->
</body>

<script>


function make_tag(tagname, text) {
    return "<" + tagname + ">" + text + "</" + tagname + ">";
}

function pre(text) {
    return make_tag(pre, text)
}

function print(name, obj) {
    document.getElementById('summary').innerHTML = "<br><strong>" + name + "<pre>" + JSON.stringify(obj, null, 2) + "</pre>";
}

function parse_csv(stringrep) {
    lines = stringrep.split("\n")
    headers = lines[0].split(',')
    console.log("headers=" + headers + " headers.length=" + headers.length)

    lists = {};


    for (var i = 0; i != headers.length; ++i) {
        headers[i] = headers[i].trim()
        lists[headers[i]] = []
    }

    for (var li = 1; li != lines.length; ++li) {
        var fields = lines[li].split(',');
        if (fields.length != headers.length) {
            break
        }
        //console.log("fields=" + fields + " fields.length=" + fields.length)
        for (var fi = 0; fi != headers.length; ++fi) {
            lists[headers[fi]].push(fields[fi])
        }
    }

    return lists
}

//document.getElementById('input').value = "speed,rtt,cwnd\n111,11,1\n222,22,2\n333,33,3"


document.getElementById('input').value = `time,  cwnd,    rtt,      rtt.max,   rtt.min,  txbytes
61,    137319,  2398612,  8552293,   1736261,  48369360
62,    160061,  3147695,  10229304,  2050121,  48286480
63,    345227,  5986569,  9698224,   2256032,  53845360
64,    227186,  4392060,  9523208,   1938289,  48101480
65,    375826,  4449655,  9933859,   2249340,  56075720
66,    151590,  2433335,  12664259,  2259417,  51839960
67,    388687,  6396743,  11864148,  1998901,  53359920
68,    575996,  7562008,  27251352,  2946322,  63163440
69,    172083,  3553161,  20340175,  1981390,  53534560
70,    250818,  4672844,  7465536,   2413946,  11406400
71,    0,       0,        0,         0,        0
`;


function refresh() {
    lists = parse_csv(document.getElementById('input').value)
    //print("After parsing:", lists)

    var ul = document.getElementById("fields");
    ul.innerHTML = ""
    for (var field in lists) {
        ul.innerHTML += '<li><input type="checkbox" id="' + field + '" onclick="refresh_graph()" >&nbsp' + field + '</input></li>';
    }

    refresh_graph()
}

function refresh_graph() {
    Plotly.newPlot('tcp_graph', get_graphs(lists));
}


function get_graphs(lists) {
    var result = [];
    for (var field in lists) {
        document.getElementById(field).checked = true;

        var item = {
            name: field,
            type: 'scatter'
        };
        if (field != "time") {
            item.x = lists["time"];
            item.y = lists[field];
        }
        result.push(item);
    }
    console.log("result: " + JSON.stringify(result, null, 2));
    return result;
}
refresh();


</script>
